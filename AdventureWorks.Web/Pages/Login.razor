@page "/"
@page "/login"
@layout GuestLayout
@using System.ComponentModel.DataAnnotations
@using System.Net.Http.Json
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthStateProvider

<PageTitle>Login</PageTitle>

<div style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
    <FluentCard Style="width: 400px; padding: 2rem;">

        <h3 style="margin-bottom: 1.5rem; text-align: center;">Login</h3>

        @if (!string.IsNullOrEmpty(Message))
        {
            <FluentMessageBar Intent="MessageIntent.Error" Style="margin-bottom: 1rem;">
                @Message
            </FluentMessageBar>
        }

        <EditForm Model="Credentials" OnValidSubmit="HandleLogin">
            <DataAnnotationsValidator />
            <FluentValidationSummary />

            <FluentStack Orientation="Orientation.Vertical" VerticalGap="16">

                <FluentTextField @bind-Value="Credentials.Email"
                                 Label="Email"
                                 TextFieldType="TextFieldType.Email"
                                 Placeholder="contoh@email.com"
                                 Style="width: 100%;" />

                <FluentTextField @bind-Value="Credentials.Password"
                                 Label="Password"
                                 TextFieldType="TextFieldType.Password"
                                 Placeholder="Masukkan password"
                                 Style="width: 100%;" />

                <FluentButton Type="ButtonType.Submit"
                              Appearance="Appearance.Accent"
                              Style="width: 100%; margin-top: 0.5rem;">
                    Login
                </FluentButton>

            </FluentStack>
        </EditForm>

    </FluentCard>
</div>

@code {
    private LoginModel Credentials { get; set; } = new();
    private string? Message { get; set; }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var state = await AuthStateProvider.GetAuthenticationStateAsync();
            if (state.User?.Identity?.IsAuthenticated == true)
            {
                // Already authenticated: redirect to main/home
                Navigation.NavigateTo("/home", true);
            }
        }
        catch
        {
            // ignore and continue to show login
        }
    }

    private async Task HandleLogin()
    {
        Message = null;
        try
        {
            // Use the provided API endpoint
            var response = await Http.PostAsJsonAsync("https://localhost:60241/users/login", Credentials);
            if (response.IsSuccessStatusCode)
            {
                // Try to parse token from response JSON (common shapes: { "token": "..." } or { "access_token": "..." })
                string? token = null;
                try
                {
                    var doc = await response.Content.ReadFromJsonAsync<JsonElement>();
                    if (doc.ValueKind == JsonValueKind.Object)
                    {
                        if (doc.TryGetProperty("token", out var t) && t.ValueKind == JsonValueKind.String)
                            token = t.GetString();
                        else if (doc.TryGetProperty("access_token", out var at) && at.ValueKind == JsonValueKind.String)
                            token = at.GetString();
                    }
                    else
                    {
                        // fallback to raw string
                        var raw = await response.Content.ReadAsStringAsync();
                        token = raw;
                    }
                }
                catch
                {
                    token = await response.Content.ReadAsStringAsync();
                }

                if (!string.IsNullOrWhiteSpace(token))
                {
                    if (AuthStateProvider is AdventureWorks.Web.Services.ApiAuthenticationStateProvider provider)
                    {
                        await provider.MarkUserAsAuthenticated(token);
                    }

                    Navigation.NavigateTo("/home");
                    return;
                }

                var content = await response.Content.ReadAsStringAsync();
                Message = $"Login successful";
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Message = $"Login failed";
            }
        }
        catch (Exception ex)
        {
            Message = $"An error occurred: {ex.Message}";
        }
    }

    private class LoginModel
    {
        [Required]
        public string? Email { get; set; }

        [Required]
        public string? Password { get; set; }
    }
}
